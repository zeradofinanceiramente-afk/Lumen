
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // =================================================================================
    // ðŸ›¡ï¸ SECURITY KERNEL
    // =================================================================================

    function isAuthenticated() {
      return request.auth != null;
    }

    function isUser(uid) {
      return isAuthenticated() && request.auth.uid == uid;
    }

    // Helper seguro para obter dados do usuÃ¡rio sem quebrar a avaliaÃ§Ã£o se o doc nÃ£o existir
    function getUserRole() {
      let userDoc = get(/databases/$(database)/documents/users/$(request.auth.uid));
      // Verifica se o documento existe e tem o campo role
      return (userDoc != null && userDoc.data != null && 'role' in userDoc.data) 
             ? userDoc.data.role 
             : null;
    }

    function isTeacher() {
      return isAuthenticated() && getUserRole() == 'professor';
    }

    function isAdmin() {
      return isAuthenticated() && getUserRole() == 'admin';
    }

    function isValidString(text, min, max) {
      return text is string && text.size() >= min && text.size() <= max;
    }

    function isNumber(val) {
      return val is int || val is float;
    }
    
    // Verifica se campos sensÃ­veis NÃƒO estÃ£o sendo alterados
    function notUpdating(field) {
      return !(field in request.resource.data) || resource.data[field] == request.resource.data[field];
    }

    // =================================================================================
    // ðŸ‘¤ USUÃRIOS
    // =================================================================================

    match /users/{userId} {
      // Permite leitura pÃºblica autenticada (necessÃ¡rio para getUserRole funcionar em queries de outros)
      allow read: if isAuthenticated(); 
      
      allow create: if isUser(userId)
        && isValidString(request.resource.data.name, 1, 100);

      allow update: if isUser(userId) 
        && notUpdating('role'); // NÃ£o pode mudar seu prÃ³prio papel via client

      match /quiz_results/{quizId} { allow read, write: if isUser(userId); }
      match /modulesProgress/{moduleId} { allow read, write: if isUser(userId); }
      match /read_notifications/{notifId} { allow read, write: if isUser(userId); }
    }

    // =================================================================================
    // ðŸ« TURMAS
    // =================================================================================

    match /classes/{classId} {
      allow read: if isAuthenticated();
      
      allow create: if isTeacher() || isAdmin();
      
      allow update: if isTeacher() || isAdmin() || 
                    // Alunos entrando/saindo (atualiza array students)
                    (isAuthenticated() && notUpdating('name') && notUpdating('teacherId'));
                    
      allow delete: if isTeacher() || isAdmin();
    }

    // =================================================================================
    // ðŸ“š CONTEÃšDO (MÃ³dulos, Quizzes, Atividades)
    // =================================================================================

    match /modules/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /module_contents/{moduleId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }
    match /quizzes/{quizId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher() || isAdmin();
    }

    // ATIVIDADES
    match /activities/{activityId} {
      allow read: if isAuthenticated();
      allow create: if isTeacher();
      
      // Permitir atualizaÃ§Ã£o de contadores pelos alunos (incremento de submissionCount)
      allow update: if isTeacher() || isAuthenticated();
      
      allow delete: if isTeacher();

      // SUBMISSÃ•ES - Regras especÃ­ficas (Nested)
      match /submissions/{submissionId} {
        allow read: if (isAuthenticated() && resource.data.studentId == request.auth.uid) || isTeacher();
        allow create: if (isAuthenticated() && request.resource.data.studentId == request.auth.uid) || isTeacher();
        allow update: if (isAuthenticated() && resource.data.studentId == request.auth.uid) || isTeacher();
      }
    }

    // SUBMISSÃ•ES - Regras Globais (Collection Group Query)
    match /{path=**}/submissions/{submissionId} {
      allow read: if isAuthenticated() && (
        resource.data.studentId == request.auth.uid || isTeacher()
      );
    }

    // =================================================================================
    // ðŸ† GAMIFICATION & SISTEMA
    // =================================================================================

    match /achievements/{id} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    match /userAchievements/{userId} {
      allow read: if isAuthenticated();
      allow write: if isUser(userId); 
    }
    
    // BOLETIM / HISTÃ“RICO ESCOLAR
    match /student_grades/{id} {
      // Regra Crucial: Permite leitura se o usuÃ¡rio logado for o dono do boletim (studentId)
      // Isso funciona independente de estar ativo na turma ou nÃ£o, pois o studentId fica gravado no documento.
      allow read: if isUser(resource.data.studentId) || isTeacher();
      
      // Apenas professores (ou sistema) devem criar/atualizar notas
      allow write: if isTeacher();
    }
    
    match /notifications/{id} {
      allow read: if isUser(resource.data.userId);
      allow create: if isAuthenticated(); // Sistema ou Trigger cria
      allow update: if isUser(resource.data.userId); // Marcar como lida
    }
    
    match /broadcasts/{id} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
    }
    
    match /invitations/{id} {
      allow read: if isUser(resource.data.inviteeId) || isUser(resource.data.inviterId);
      allow write: if isTeacher() || isUser(resource.data.inviteeId);
    }

    match /teacher_history/{userId} {
      allow read, write: if isUser(userId);
    }

    match /attendance_sessions/{sessionId} {
      allow read: if isAuthenticated();
      allow write: if isTeacher();
      
      match /records/{recordId} {
        allow read: if isAuthenticated();
        allow write: if isTeacher();
      }
    }

    match /{document=**} {
      allow read, write: if false;
    }
  }
}
